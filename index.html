<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ˆë¥¼ ìœ„í•œ ì´ì•¼ê¸°</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-spring: #fef7f0;
            --secondary-spring: #fff5f8;
            --accent-pink: #ffb3d6;
            --accent-peach: #ffcccb;
            --accent-green: #98e4d6;
            --text-dark: #2d3436;
            --text-muted: #636e72;
            --cherry-pink: #ffb7c5;
            --lily-white: #ffffff;
            --sakura-pink: #ffc0cb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--primary-spring) 0%, var(--secondary-spring) 50%, #f8f9ff 100%);
            color: var(--text-dark);
            overflow: hidden;
            height: 100%;
        }

        .page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            background: linear-gradient(135deg, var(--primary-spring) 0%, var(--secondary-spring) 30%, #f0f8ff 100%);
        }

        .page.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        /* Animated petals */
        .petals {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 2;
            pointer-events: none;
        }

        .petal {
            position: absolute;
            border-radius: 50% 0 50% 50%;
            animation: petalFall 8s infinite linear;
        }

        .cherry-petal {
            background: linear-gradient(45deg, var(--cherry-pink), var(--sakura-pink));
            width: 12px;
            height: 8px;
        }

        .lily-petal {
            background: linear-gradient(45deg, var(--lily-white), #f8f9fa);
            width: 15px;
            height: 10px;
            border-radius: 60% 0 60% 60%;
        }

        @keyframes petalFall {
            0% {
                transform: translateY(-100px) translateX(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translateY(50vh) translateX(20px) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) translateX(-20px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Intro Page */
        .intro-content {
            text-align: center;
            z-index: 10;
            position: relative;
        }

        .intro-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(2.5rem, 8vw, 5rem);
            font-weight: 300;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, var(--accent-pink), var(--accent-peach), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: springGlow 3s infinite alternate;
        }

        @keyframes springGlow {
            0% { filter: drop-shadow(0 0 10px rgba(255, 179, 214, 0.4)); }
            100% { filter: drop-shadow(0 0 20px rgba(255, 179, 214, 0.7)); }
        }

        .intro-subtitle {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 3rem;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .start-button {
            padding: 1rem 3rem;
            background: linear-gradient(45deg, var(--accent-pink), var(--accent-peach));
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(255, 179, 214, 0.3);
            z-index: 5;
        }

        .start-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .start-button:hover::before {
            left: 100%;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 179, 214, 0.5);
        }

        /* Video Page */
        .video-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            position: relative;
            background: radial-gradient(circle at 30% 20%, #fff5f8 0%, #fef7f0 40%, #f0f8ff 100%);
        }

        .video-frame {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        .main-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .tap-to-play {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            color: #fff;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
            cursor: pointer;
            z-index: 20;
            backdrop-filter: blur(3px);
        }

        .tap-to-play.show {
            display: flex;
        }

        .video-message {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s ease;
            text-align: center;
            margin-bottom: 2rem;
            z-index: 30;
            position: relative;
        }

        .video-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .video-message h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            color: var(--accent-pink);
            margin-bottom: 1rem;
        }

        .video-message p {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .next-button {
            padding: 0.8rem 2.5rem;
            background: transparent;
            border: 2px solid var(--accent-pink);
            border-radius: 30px;
            color: var(--accent-pink);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 5;
        }

        .next-button:hover {
            background: var(--accent-pink);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 179, 214, 0.3);
        }

        /* Pledge Modal */
        .pledge-modal {
            position: fixed;
            inset: 0;
            background: rgba(18, 18, 22, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 2rem;
            backdrop-filter: blur(6px);
        }

        .pledge-modal.show {
            display: flex;
            animation: modalFadeIn 0.5s ease;
        }

        .signature-modal {
            position: fixed;
            inset: 0;
            background: rgba(18, 18, 22, 0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
            padding: 2rem;
            backdrop-filter: blur(6px);
        }

        .signature-modal.show {
            display: flex;
            animation: modalFadeIn 0.4s ease;
        }

        .signature-sheet {
            width: min(760px, 94vw);
            background: #fffdf8;
            border-radius: 24px;
            padding: 2.2rem;
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.22);
            position: relative;
            border: 1px solid rgba(255, 179, 214, 0.3);
        }

        .signature-sheet h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .signature-canvas-large {
            width: 100%;
            height: 240px;
            border-radius: 18px;
            border: 1px solid rgba(99, 110, 114, 0.3);
            background: #fff;
            box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.05);
        }

        .signature-status {
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .accept-button {
            padding: 0.9rem 2.2rem;
            border: none;
            border-radius: 30px;
            background: linear-gradient(45deg, var(--accent-pink), var(--accent-peach));
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .accept-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .pledge-paper {
            width: min(720px, 92vw);
            background: linear-gradient(180deg, #fffdf8 0%, #fff8f2 100%);
            border-radius: 24px;
            padding: 2.5rem 2.2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            position: relative;
            transform-origin: top center;
            animation: unfold 0.9s cubic-bezier(0.22, 0.61, 0.36, 1);
            border: 1px solid rgba(255, 179, 214, 0.3);
            overflow: hidden;
        }

        @keyframes unfold {
            0% { transform: scaleY(0.1) translateY(-40px); opacity: 0; }
            60% { transform: scaleY(1.05) translateY(0); opacity: 1; }
            100% { transform: scaleY(1) translateY(0); opacity: 1; }
        }

        .pledge-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 1.2rem;
            color: var(--text-dark);
            text-align: center;
            position: relative;
        }

        .pledge-subtitle {
            text-align: center;
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-top: -0.6rem;
            margin-bottom: 1.6rem;
            letter-spacing: 0.4px;
        }

        .pledge-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
            margin: 1.5rem 0 2rem;
            color: var(--text-dark);
            font-size: 1.05rem;
            line-height: 1.6;
        }

        .pledge-item {
            padding: 0.8rem 1rem;
            border-radius: 14px;
            background: rgba(255, 179, 214, 0.12);
            border: 1px dashed rgba(255, 179, 214, 0.4);
            display: grid;
            grid-template-columns: 24px 1fr;
            gap: 0.6rem;
            align-items: start;
        }

        .pledge-item .pledge-icon {
            font-size: 1.1rem;
            line-height: 1.2;
        }

        .pledge-item .pledge-detail {
            display: block;
            color: var(--text-muted);
            font-size: 0.95rem;
            margin-top: 0.35rem;
        }

        .pledge-note {
            text-align: center;
            color: var(--text-muted);
            font-size: 1.05rem;
            margin-top: -0.6rem;
            margin-bottom: 1.8rem;
            font-weight: 600;
            letter-spacing: 0.4px;
        }

        .signature-row {
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
            align-items: stretch;
        }

        .signature-canvas {
            width: 100%;
            height: 140px;
            border-radius: 16px;
            border: 1px solid rgba(99, 110, 114, 0.3);
            background: #fff;
            box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.05);
        }

        .signature-canvas.signature-warn {
            border-color: var(--accent-pink);
            box-shadow: 0 0 0 2px rgba(255, 179, 214, 0.35);
        }

        .signature-actions {
            display: flex;
            gap: 0.8rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .signature-clear {
            padding: 0.7rem 1.6rem;
            border-radius: 30px;
            border: 1px solid rgba(99, 110, 114, 0.35);
            background: #fff;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .signature-clear:hover {
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .sign-button {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 30px;
            background: linear-gradient(45deg, var(--accent-pink), var(--accent-peach));
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .sign-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(255, 179, 214, 0.4);
        }

        .pledge-close {
            position: absolute;
            top: 14px;
            right: 18px;
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* Fireworks */
        .fireworks-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 80;
            overflow: hidden;
        }

        .firework {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #fff;
            opacity: 0;
            animation: explode 1.3s ease-out forwards;
        }

        @keyframes explode {
            0% { transform: translate(0, 0) scale(0.2); opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(1.2); opacity: 0; }
        }

        /* Confession Page */
        .confession-content {
            text-align: center;
            max-width: 600px;
            z-index: 10;
            position: relative;
            padding: 2rem;
        }

        .confession-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(2rem, 6vw, 3.5rem);
            font-weight: 400;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, var(--accent-pink), var(--accent-peach), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .confession-message {
            font-size: 1.3rem;
            color: var(--text-dark);
            margin-bottom: 3rem;
            line-height: 1.6;
            font-weight: 300;
        }

        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }

        .choice-button {
            padding: 1.2rem 3rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            position: relative;
            overflow: hidden;
            z-index: 5;
        }

        .choice-button.yes {
            background: linear-gradient(45deg, var(--cherry-pink), var(--accent-pink));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 183, 197, 0.3);
        }

        .choice-button.maybe {
            background: transparent;
            border: 2px solid var(--text-muted);
            color: var(--text-muted);
        }

        .choice-button:hover {
            transform: translateY(-3px);
        }

        .choice-button.yes:hover {
            box-shadow: 0 15px 40px rgba(255, 183, 197, 0.4);
        }

        .choice-button.maybe:hover {
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        /* Heart Animation */
        .heart {
            position: absolute;
            font-size: 20px;
            color: var(--cherry-pink);
            animation: heartFloat 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes heartFloat {
            0% {
                transform: translateY(100vh) scale(0) rotate(0deg);
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            80% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) scale(1.5) rotate(360deg);
                opacity: 0;
            }
        }

        /* Final Screen */
        .final-message {
            text-align: center;
            z-index: 10;
            position: relative;
        }

        .final-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(2.5rem, 8vw, 5rem);
            font-weight: 300;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, var(--accent-peach), var(--accent-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: celebrationGlow 2s infinite alternate;
        }

        @keyframes celebrationGlow {
            0% { filter: drop-shadow(0 0 15px rgba(255, 204, 203, 0.4)); }
            100% { filter: drop-shadow(0 0 30px rgba(255, 204, 203, 0.7)); }
        }

        .final-subtitle {
            font-size: 1.4rem;
            color: var(--text-dark);
            margin-bottom: 2rem;
            font-weight: 300;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .choice-buttons {
                gap: 1.5rem;
            }
            
            .choice-button {
                min-width: 200px;
                padding: 1rem 2rem;
            }
            
            .confession-content {
                padding: 1rem;
            }
        }

        /* Music Note Animation */
        .music-note {
            position: absolute;
            font-size: 24px;
            color: var(--accent-peach);
            animation: musicFloat 4s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes musicFloat {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.6;
            }
            50% {
                transform: translateY(-20px) rotate(10deg);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Petals Background -->
    <div class="petals" id="petals"></div>

    <!-- BGM -->
    <audio id="bgmFirst" src="audio/first.mp3" loop preload="auto"></audio>
    <audio id="bgmModal" src="audio/modal.mp3" loop preload="auto"></audio>
    <audio id="bgmFinal" src="audio/final.mp3" loop preload="auto"></audio>

    <!-- Intro Page -->
    <div class="page active" id="introPage">
        <div class="intro-content">
            <h1 class="intro-title">ì´ê±´ ë„ˆë¥¼ ìœ„í•œ ì´ì•¼ê¸°ì•¼</h1>
            <p class="intro-subtitle">ê³¼ì—° ë­ê°€ ë“¤ì—ˆì„ê¹Œë‚˜</p>
            <button class="start-button" onclick="goToVideo()">ì—´ì–´ë³´ê¸°</button>
        </div>
    </div>

    <!-- Video Page -->
    <div class="page" id="videoPage">
        <div class="video-container">
            <div class="video-placeholder">
                <div class="video-text">
                    ì˜ìƒì´ ì´ê³³ì— ì¬ìƒë©ë‹ˆë‹¤<br>
                    <small style="font-size: 0.8em; color: #888;">(ì‹¤ì œ ì˜ìƒ íŒŒì¼ì„ ì¶”ê°€í•˜ì„¸ìš”)</small>
                </div>
            </div>
            <div class="video-message" id="videoMessage">
                <h2>ë‚´ ë§ˆìŒ, ì´ì œ ë§í• ê²Œ...</h2>
                <p>ì´ ì˜ìƒì„ ë³´ê³  ìˆë‹¤ë©´, ë‚´ê°€ ì „í•˜ê³  ì‹¶ì—ˆë˜ ë§ˆìŒì„ ì•Œ ê²ƒ ê°™ì•„</p>
                <button class="next-button" onclick="goToConfession()">ë‚˜ì˜ ëŒ€ë‹µì€?</button>
            </div>
        </div>
    </div>

    <!-- Confession Page -->
    <div class="page" id="confessionPage">
        <div class="confession-content">
            <h1 class="confession-title">ë„ ì²˜ìŒ ë³¸ ìˆœê°„ë¶€í„°,<br>ì´ ë§ì„ ì „í•˜ê³  ì‹¶ì—ˆì–´</h1>
            <p class="confession-message">
                ë„ˆì™€ í•¨ê»˜í•˜ëŠ” ëª¨ë“  ìˆœê°„ì´ íŠ¹ë³„í•˜ê³ ,<br>
                ë„ˆì˜ ì›ƒìŒ ì†Œë¦¬ê°€ ë‚´ í•˜ë£¨ë¥¼ ë°ê²Œ ë§Œë“¤ì–´.<br>
                ì´ì œ ì†”ì§í•˜ê²Œ ë§í• ê²Œ... ë‚˜ëŠ” ë„ˆë¥¼ ì¢‹ì•„í•´.
            </p>
            <div class="choice-buttons">
                <button class="choice-button yes" onclick="showCelebration()">
                    â¤ï¸ ë‚˜ë„ ë„ˆë¥¼ ì¢‹ì•„í•´
                </button>
                <button class="choice-button maybe" onclick="showUnderstanding()">
                    ğŸ¤ ì¡°ê¸ˆë§Œ ë” ìƒê°í• ê²Œ
                </button>
            </div>
        </div>
    </div>

    <!-- Final Celebration Page -->
    <div class="page" id="celebrationPage">
        <div class="final-message">
            <h1 class="final-title">ë§ë‚˜?! ğŸ’•</h1>
            <p class="final-subtitle">í‰ìƒ ë„ˆë§Œ ë°”ë¼ë³´ê³  ì‚¬ë‘í• ê²Œ<br>ê²°í˜¼ì´ë¼ëŠ” ì•„ë¦„ë‹¤ìš´ ì—´ë§¤ë¥¼ ë§ºì–´ë‚˜ê°€ì</p>
        </div>
    </div>

    <!-- Final Understanding Page -->
    <div class="page" id="understandingPage">
        <div class="final-message">
            <h1 class="final-title" style="background: linear-gradient(45deg, var(--text-dark), var(--text-muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ê´œì°®ì•„ ğŸ¤—</h1>
            <p class="final-subtitle">ë„ˆì˜ ë§ˆìŒì´ í¸í•œ ê²Œ ê°€ì¥ ì¤‘ìš”í•´.<br>ìš°ë¦¬ì˜ ì‚¬ë‘ì€ ì–¸ì œë‚˜ ì†Œì¤‘í•  ê±°ì•¼.</p>
        </div>
    </div>

    <script>
        // Clean script (replaces broken hotfix/legacy)
        let signatureSaved = false;
        let signatureDataUrl = '';
        function createPetals() {
            const petalsContainer = document.getElementById('petals');
            if (!petalsContainer) return;
            const petalCount = 30;

            for (let i = 0; i < petalCount; i++) {
                const petal = document.createElement('div');
                const isCherry = Math.random() > 0.5;
                petal.className = isCherry ? 'petal cherry-petal' : 'petal lily-petal';
                petal.style.left = Math.random() * 100 + '%';
                petal.style.animationDuration = (Math.random() * 5 + 6) + 's';
                petal.style.animationDelay = Math.random() * 8 + 's';
                petalsContainer.appendChild(petal);
            }
        }

        function createFallingPetal() {
            const petal = document.createElement('div');
            const isCherry = Math.random() > 0.4;
            petal.className = isCherry ? 'petal cherry-petal' : 'petal lily-petal';
            petal.style.left = Math.random() * 100 + '%';
            petal.style.animationDuration = (Math.random() * 3 + 4) + 's';
            document.body.appendChild(petal);
            setTimeout(() => petal.remove(), 8000);
        }

        function createHeart() {
            const heart = document.createElement('div');
            heart.className = 'heart';
            const hearts = ['â™¥', 'â¤', 'ğŸ’•', 'ğŸ’–'];
            heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
            heart.style.left = Math.random() * 100 + '%';
            heart.style.animationDuration = (Math.random() * 2 + 3) + 's';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 5000);
        }

        function createMusicNote() {
            const note = document.createElement('div');
            note.className = 'music-note';
            const notes = ['â™ª', 'â™«', 'â™¬', 'â™©'];
            note.innerHTML = notes[Math.floor(Math.random() * notes.length)];
            note.style.left = Math.random() * 100 + '%';
            note.style.top = Math.random() * 100 + '%';
            note.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(note);
            setTimeout(() => note.remove(), 4000);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            setTimeout(() => {
                const target = document.getElementById(pageId);
                if (target) target.classList.add('active');
            }, 300);

            if (pageId === 'introPage') {
                playBgm('first');
            }
            if (pageId === 'celebrationPage') {
                playBgm('final');
            }
        }

        function playBgm(mode) {
            const tracks = {
                first: document.getElementById('bgmFirst'),
                modal: document.getElementById('bgmModal'),
                final: document.getElementById('bgmFinal')
            };

            Object.values(tracks).forEach(track => {
                if (!track) return;
                track.pause();
                track.currentTime = 0;
            });

            const target = tracks[mode];
            if (!target) return;
            target.volume = 0.8;
            const playPromise = target.play();
            if (playPromise && typeof playPromise.catch === 'function') {
                playPromise.catch(() => {});
            }
        }

        function ensureVideoFrame() {
            const container = document.querySelector('#videoPage .video-container');
            let frame = container.querySelector('.video-frame');

            if (!frame) {
                frame = document.createElement('div');
                frame.className = 'video-frame';
                frame.innerHTML = `
                    <video id="mainVideo" class="main-video" playsinline muted></video>
                    <div class="tap-to-play" id="tapToPlay">Tap or click to play the video</div>
                `;

                const placeholder = container.querySelector('.video-placeholder');
                if (placeholder) {
                    placeholder.replaceWith(frame);
                } else {
                    container.prepend(frame);
                }
            }

            return frame.querySelector('#mainVideo');
        }

        function requestFullScreen(element) {
            if (element.requestFullscreen) return element.requestFullscreen();
            if (element.webkitEnterFullscreen) return element.webkitEnterFullscreen();
            if (element.webkitRequestFullscreen) return element.webkitRequestFullscreen();
            if (element.msRequestFullscreen) return element.msRequestFullscreen();
        }

        function exitFullScreen() {
            if (document.exitFullscreen) return document.exitFullscreen();
            if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
            if (document.msExitFullscreen) return document.msExitFullscreen();
        }

        function ensurePledgeModal() {
            if (document.getElementById('pledgeModal')) return;
            const modalHtml = `
                <div class="pledge-modal" id="pledgeModal" aria-hidden="true">
                    <div class="pledge-paper">
                        <button class="pledge-close" onclick="closePledge()">Ã—</button>
                        <h2 class="pledge-title">ìš°ë¦¬ê°€ ê¾¸ë ¤ê°ˆ ê°€ì • ê·œì¹™</h2>
                        <ul class="pledge-list">
                            <li class="pledge-item">1. We respect and trust each other.</li>
                            <li class="pledge-item">2. We talk even when we are busy.</li>
                            <li class="pledge-item">3. We honor different opinions with care.</li>
                            <li class="pledge-item">4. We keep kindness during disagreements.</li>
                            <li class="pledge-item">5. We cherish this moment sincerely.</li>
                        </ul>
                        <div class="signature-row">
                            <canvas class="signature-canvas" id="signatureCanvas"></canvas>
                            <div class="signature-actions">
                                <button class="signature-clear" onclick="clearSignature()">Clear</button>
                                <button class="sign-button" onclick="signPledge()">Sign</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fireworks-layer" id="fireworksLayer"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            normalizePledgeModal();
            ensureSignatureModal();
        }

        function normalizePledgeModal() {
            const modal = document.getElementById('pledgeModal');
            if (!modal) return;

            const closeBtn = modal.querySelector('.pledge-close');
            if (closeBtn) closeBtn.textContent = 'Ã—';

            const title = modal.querySelector('.pledge-title');
            if (title) title.textContent = 'ìš°ë¦¬ê°€ ê¾¸ë ¤ê°ˆ ê°€ì • ê·œì¹™';

            const existingSubtitle = modal.querySelector('.pledge-subtitle');
            if (existingSubtitle) {
                existingSubtitle.textContent = 'ê¹€ì§„ì„± Â· ì¡°ì˜ˆì€';
            } else {
                const subtitle = document.createElement('p');
                subtitle.className = 'pledge-subtitle';
                subtitle.textContent = 'ê¹€ì§„ì„± Â· ì¡°ì˜ˆì€';
                title.insertAdjacentElement('afterend', subtitle);
            }

            const list = modal.querySelector('.pledge-list');
            if (list) {
                list.innerHTML = `
                    <li class="pledge-item"><span class="pledge-icon">ğŸŒ¿</span><span>1. ë¨¸ë¦¬ë¡œ ì´í•´í•˜ì§€ ì•Šê¸°<span class="pledge-detail">(ì‚¬ë‘ìœ¼ë¡œ ì´í•´í•˜ê¸°)</span></span></li>
                    <li class="pledge-item"><span class="pledge-icon">ğŸ•Šï¸</span><span>2. ìƒëŒ€ íƒ“í•˜ì§€ ì•Šê¸°<span class="pledge-detail">(ì´ê¸°ì‹¬ ë²„ë¦¬ê¸°)</span></span></li>
                    <li class="pledge-item"><span class="pledge-icon">âœ¨</span><span>3. ê°€ë¬¸ì˜ ì£„ ëŠê¸°<span class="pledge-detail">(ì¢‹ì€ ê²ƒë§Œ ìœ ì‚°ìœ¼ë¡œ ë‚´ë ¤ì£¼ê¸°)</span></span></li>
                    <li class="pledge-item"><span class="pledge-icon">ğŸ‘¶</span><span>4. ìë…€ë¥¼ ë‚´ ì†Œìœ ë¡œ í‚¤ìš°ì§€ ì•Šê¸°<span class="pledge-detail">(í•˜ë‚˜ë‹˜ ëœ»ëŒ€ë¡œ ì–‘ìœ¡í•˜ê¸°)</span></span></li>
                    <li class="pledge-item"><span class="pledge-icon">ğŸ¤</span><span>5. ì„œë¡œ ì‚¬ëª… ì´ë£¨ë„ë¡ í—¬í¼í•˜ê¸°<span class="pledge-detail">(í•˜ë‚˜ë‹˜ê»˜ì„œ ë³´ì‹œëŠ” ê·¸ ì‚¬ë‘ì— ëŒ€í•œ ê³„íš ë°”ë¼ë³´ê¸°)</span></span></li>
                `;
            }

            const noteExisting = modal.querySelector('.pledge-note');
            if (!noteExisting && list) {
                const note = document.createElement('div');
                note.className = 'pledge-note';
                note.textContent = '* ëª¨ë“  ê²ƒì€ ë§ì”€ ê¸°ì¤€ìœ¼ë¡œ í–‰í•˜ê¸°';
                list.insertAdjacentElement('afterend', note);
            }

            const row = modal.querySelector('.signature-row');
            if (!row) return;
            row.innerHTML = `
                <div class="signature-actions">
                    <button class="signature-clear" onclick="openSignatureModal()">ì„œëª… ì—´ê¸°</button>
                    <button class="accept-button" id="acceptPledgeBtn" onclick="signPledge()" disabled>ìŠ¹ë½í•˜ê¸°</button>
                </div>
                <div class="signature-status" id="signatureStatus">ì„œëª… ë¯¸ì €ì¥</div>
            `;
        }

        function ensureSignatureModal() {
            if (document.getElementById('signatureModal')) return;
            const modalHtml = `
                <div class="signature-modal" id="signatureModal" aria-hidden="true">
                    <div class="signature-sheet">
                        <button class="pledge-close" onclick="closeSignatureModal()">Ã—</button>
                        <h3>Draw your signature</h3>
                        <canvas class="signature-canvas-large" id="signatureCanvasModal"></canvas>
                        <div class="signature-actions" style="margin-top: 1rem;">
                            <button class="signature-clear" onclick="clearSignature()">Clear</button>
                            <button class="sign-button" onclick="saveSignature()">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function openSignatureModal() {
            ensureSignatureModal();
            const modal = document.getElementById('signatureModal');
            const closeBtn = modal.querySelector('.pledge-close');
            if (closeBtn) closeBtn.textContent = 'Ã—';
            const title = modal.querySelector('h3');
            if (title) title.textContent = 'ì„œëª…í•˜ê¸°';
            const clearBtn = modal.querySelector('.signature-clear');
            if (clearBtn) clearBtn.textContent = 'ë‹¤ì‹œ ì“°ê¸°';
            const saveBtn = modal.querySelector('.sign-button');
            if (saveBtn) saveBtn.textContent = 'ì €ì¥';
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
            setupSignatureCanvas();
        }

        function closeSignatureModal() {
            const modal = document.getElementById('signatureModal');
            if (!modal) return;
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function showPledge() {
            ensurePledgeModal();
            const modal = document.getElementById('pledgeModal');
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
            updateSignatureStatus();
            playBgm('modal');
        }

        function closePledge() {
            const modal = document.getElementById('pledgeModal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function launchFireworks(count) {
            const layer = document.getElementById('fireworksLayer');
            const colors = ['#ffb3d6', '#ffcccb', '#98e4d6', '#ffd6e7', '#fce38a'];

            for (let i = 0; i < count; i++) {
                const spark = document.createElement('div');
                spark.className = 'firework';
                const angle = Math.random() * Math.PI * 2;
                const distance = 60 + Math.random() * 140;
                spark.style.left = Math.random() * 100 + '%';
                spark.style.top = Math.random() * 80 + '%';
                spark.style.background = colors[Math.floor(Math.random() * colors.length)];
                spark.style.setProperty('--dx', Math.cos(angle) * distance + 'px');
                spark.style.setProperty('--dy', Math.sin(angle) * distance + 'px');
                layer.appendChild(spark);
                setTimeout(() => spark.remove(), 1400);
            }
        }

        function signPledge() {
            if (!signatureSaved) {
                updateSignatureStatus(true);
                return;
            }
            closePledge();
            launchFireworks(26);
            setTimeout(() => showCelebration(), 1400);
        }

        function setupSignatureCanvas() {
            const canvas = document.getElementById('signatureCanvasModal');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const resizeCanvas = () => {
                const ratio = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * ratio;
                canvas.height = rect.height * ratio;
                ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
                ctx.lineWidth = 1.4;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = '#2d3436';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            resizeCanvas();
            if (canvas.dataset.bound === 'true') {
                return;
            }
            window.addEventListener('resize', resizeCanvas);

            let drawing = false;
            const start = (x, y) => {
                drawing = true;
                canvas.dataset.hasInk = 'true';
                ctx.beginPath();
                ctx.moveTo(x, y);
            };
            const move = (x, y) => {
                if (!drawing) return;
                ctx.lineTo(x, y);
                ctx.stroke();
            };
            const end = () => {
                drawing = false;
                ctx.beginPath();
            };

            const getPoint = (event) => {
                const rect = canvas.getBoundingClientRect();
                if (event.touches && event.touches[0]) {
                    return {
                        x: event.touches[0].clientX - rect.left,
                        y: event.touches[0].clientY - rect.top
                    };
                }
                return {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top
                };
            };

            canvas.addEventListener('mousedown', (event) => {
                const { x, y } = getPoint(event);
                start(x, y);
            });
            canvas.addEventListener('mousemove', (event) => {
                const { x, y } = getPoint(event);
                move(x, y);
            });
            window.addEventListener('mouseup', end);

            canvas.addEventListener('touchstart', (event) => {
                event.preventDefault();
                const { x, y } = getPoint(event);
                start(x, y);
            }, { passive: false });
            canvas.addEventListener('touchmove', (event) => {
                event.preventDefault();
                const { x, y } = getPoint(event);
                move(x, y);
            }, { passive: false });
            window.addEventListener('touchend', end);

            canvas.dataset.bound = 'true';
        }

        function clearSignature() {
            const canvas = document.getElementById('signatureCanvasModal');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.dataset.hasInk = 'false';
            canvas.classList.remove('signature-warn');
            signatureSaved = false;
            signatureDataUrl = '';
            updateSignatureStatus();
        }

        function saveSignature() {
            const canvas = document.getElementById('signatureCanvasModal');
            if (!canvas || canvas.dataset.hasInk !== 'true') {
                flashSignatureHint();
                return;
            }
            signatureDataUrl = canvas.toDataURL('image/png');
            signatureSaved = true;
            closeSignatureModal();
            updateSignatureStatus();
        }

        function updateSignatureStatus(forceWarn = false) {
            const status = document.getElementById('signatureStatus');
            const acceptBtn = document.getElementById('acceptPledgeBtn');
            if (!status || !acceptBtn) return;
            if (signatureSaved && signatureDataUrl) {
                status.innerHTML = `<img src="${signatureDataUrl}" alt="ì„œëª…" style="max-width: 220px; max-height: 90px; display: block; border: 1px solid rgba(99,110,114,0.2); border-radius: 10px; background: #fff; padding: 6px;">`;
                acceptBtn.disabled = false;
            } else {
                status.textContent = forceWarn ? 'ë¨¼ì € ì„œëª…ì„ ì €ì¥í•´ ì£¼ì„¸ìš”.' : 'ì„œëª… ë¯¸ì €ì¥';
                acceptBtn.disabled = true;
            }
        }

        function flashSignatureHint() {
            const canvas = document.getElementById('signatureCanvasModal');
            if (!canvas) return;
            canvas.classList.add('signature-warn');
            setTimeout(() => canvas.classList.remove('signature-warn'), 900);
        }

        function goToVideo() {
            showPage('videoPage');

            const video = ensureVideoFrame();
            const tapToPlay = document.getElementById('tapToPlay');

            video.src = 'video/0208.mp4';
            video.currentTime = 0;

            const tryPlay = () => {
                video.muted = false;
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        tapToPlay.classList.remove('show');
                        requestFullScreen(video);
                    }).catch(() => {
                        tapToPlay.classList.add('show');
                    });
                }
            };

            tryPlay();

            tapToPlay.onclick = () => {
                tapToPlay.classList.remove('show');
                video.muted = false;
                video.play();
                requestFullScreen(video);
            };

            video.onended = () => {
                exitFullScreen();
                showPledge();
            };

            setInterval(createMusicNote, 3000);
            setInterval(createFallingPetal, 2000);
        }

        function goToConfession() {
            showPage('confessionPage');
            setInterval(createFallingPetal, 3000);
        }

        function showCelebration() {
            showPage('celebrationPage');
            setInterval(createHeart, 300);
            setInterval(createFallingPetal, 500);
            setTimeout(() => {
                setInterval(() => {
                    createMusicNote();
                    createHeart();
                    createFallingPetal();
                }, 500);
            }, 500);
        }

        function showUnderstanding() {
            showPage('understandingPage');
            setInterval(createHeart, 2000);
            setInterval(createFallingPetal, 2500);
        }

        document.addEventListener('DOMContentLoaded', () => {
            createPetals();
            ensurePledgeModal();
            ensureSignatureModal();
            playBgm('first');
            setInterval(() => {
                if (document.getElementById('introPage').classList.contains('active')) {
                    if (Math.random() > 0.6) createFallingPetal();
                    if (Math.random() > 0.8) createMusicNote();
                }
            }, 2000);
        });
    </script>
    <script type="text/plain" id="brokenHotfix">
        // Hotfix script to restore functionality (legacy script has encoding errors)
        function createPetals() {
            const petalsContainer = document.getElementById('petals');
            if (!petalsContainer) return;
            const petalCount = 30;

            for (let i = 0; i < petalCount; i++) {
                const petal = document.createElement('div');
                const isCherry = Math.random() > 0.5;
                petal.className = isCherry ? 'petal cherry-petal' : 'petal lily-petal';
                petal.style.left = Math.random() * 100 + '%';
                petal.style.animationDuration = (Math.random() * 5 + 6) + 's';
                petal.style.animationDelay = Math.random() * 8 + 's';
                petalsContainer.appendChild(petal);
            }
        }

        function createFallingPetal() {
            const petal = document.createElement('div');
            const isCherry = Math.random() > 0.4;
            petal.className = isCherry ? 'petal cherry-petal' : 'petal lily-petal';
            petal.style.left = Math.random() * 100 + '%';
            petal.style.animationDuration = (Math.random() * 3 + 4) + 's';
            document.body.appendChild(petal);
            setTimeout(() => petal.remove(), 8000);
        }

        function createHeart() {
            const heart = document.createElement('div');
            heart.className = 'heart';
            const hearts = ['â™¥', 'â¤', 'ğŸ’•', 'ğŸ’–'];
            heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
            heart.style.left = Math.random() * 100 + '%';
            heart.style.animationDuration = (Math.random() * 2 + 3) + 's';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 5000);
        }

        function createMusicNote() {
            const note = document.createElement('div');
            note.className = 'music-note';
            const notes = ['â™ª', 'â™«', 'â™¬', 'â™©'];
            note.innerHTML = notes[Math.floor(Math.random() * notes.length)];
            note.style.left = Math.random() * 100 + '%';
            note.style.top = Math.random() * 100 + '%';
            note.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(note);
            setTimeout(() => note.remove(), 4000);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            setTimeout(() => {
                const target = document.getElementById(pageId);
                if (target) target.classList.add('active');
            }, 300);
        }

        function ensureVideoFrame() {
            const container = document.querySelector('#videoPage .video-container');
            let frame = container.querySelector('.video-frame');

            if (!frame) {
                frame = document.createElement('div');
                frame.className = 'video-frame';
                frame.innerHTML = `
                    <video id="mainVideo" class="main-video" playsinline muted></video>
                    <div class="tap-to-play" id="tapToPlay">í„°ì¹˜/í´ë¦­í•˜ì—¬ ì˜ìƒì„ ì¬ìƒí•´ ì£¼ì„¸ìš”</div>
                `;

                const placeholder = container.querySelector('.video-placeholder');
                if (placeholder) {
                    placeholder.replaceWith(frame);
                } else {
                    container.prepend(frame);
                }
            }

            return frame.querySelector('#mainVideo');
        }

        function requestFullScreen(element) {
            if (element.requestFullscreen) return element.requestFullscreen();
            if (element.webkitEnterFullscreen) return element.webkitEnterFullscreen();
            if (element.webkitRequestFullscreen) return element.webkitRequestFullscreen();
            if (element.msRequestFullscreen) return element.msRequestFullscreen();
        }

        function exitFullScreen() {
            if (document.exitFullscreen) return document.exitFullscreen();
            if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
            if (document.msExitFullscreen) return document.msExitFullscreen();
        }

        function ensurePledgeModal() {
            if (document.getElementById('pledgeModal')) return;
            const modalHtml = `
                <div class="pledge-modal" id="pledgeModal" aria-hidden="true">
                    <div class="pledge-paper">
                        <button class="pledge-close" onclick="closePledge()">Ã—</button>
                        <h2 class="pledge-title">ì„œì•½ì„œ</h2>
                        <ul class="pledge-list">
                            <li class="pledge-item">1. í˜‘ë ¥í•˜ê³  ì‹ ë¢°í•˜ë©° ì„œë¡œ ì•„ë¦„ë‹¤ìš´ ê°ì •ì„ ì§€í‚¨ë‹¤.</li>
                            <li class="pledge-item">2. ì‹œê°„ì„ ì†Œì¤‘íˆ ì‚¬ê³ , ë°”ì˜ë”ë¼ë„ ì„œë¡œì—ê²Œ ì´ì•¼ê¸°í•œë‹¤.</li>
                            <li class="pledge-item">3. ì„œë¡œì˜ ë§Œì¡±ê³¼ ë‹¤ì–‘ì„±ì„ ì¡´ì¤‘í•˜ë©°, ìƒë°˜ëœ ìƒê°ì„ ì˜¬ë ¤ë†“ëŠ”ë‹¤.</li>
                            <li class="pledge-item">4. íŒŒì´íŠ¸ë¥¼ í•  ë•Œë„ ê°ì •ì„ ë‚¨ê²¨ë‘ê³  ì‹ ë¢°ë¥¼ ê°€ì§€ë„ë¡ ë…¸ë ¥í•œë‹¤.</li>
                            <li class="pledge-item">5. ì§€ê¸ˆì˜ ì†Œì¤‘í•œ ë§ˆìŒì„ ì˜ì›í•˜ê²Œ ê°„ì§í•œë‹¤.</li>
                        </ul>
                        <div class="signature-row">
                            <canvas class="signature-canvas" id="signatureCanvas"></canvas>
                            <div class="signature-actions">
                                <button class="signature-clear" onclick="clearSignature()">ë‹¤ì‹œ ì“°ê¸°</button>
                                <button class="sign-button" onclick="signPledge()">ì„œëª…í•˜ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fireworks-layer" id="fireworksLayer"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function showPledge() {
            ensurePledgeModal();
            const modal = document.getElementById('pledgeModal');
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closePledge() {
            const modal = document.getElementById('pledgeModal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function launchFireworks(count) {
            const layer = document.getElementById('fireworksLayer');
            const colors = ['#ffb3d6', '#ffcccb', '#98e4d6', '#ffd6e7', '#fce38a'];

            for (let i = 0; i < count; i++) {
                const spark = document.createElement('div');
                spark.className = 'firework';
                const angle = Math.random() * Math.PI * 2;
                const distance = 60 + Math.random() * 140;
                spark.style.left = Math.random() * 100 + '%';
                spark.style.top = Math.random() * 80 + '%';
                spark.style.background = colors[Math.floor(Math.random() * colors.length)];
                spark.style.setProperty('--dx', Math.cos(angle) * distance + 'px');
                spark.style.setProperty('--dy', Math.sin(angle) * distance + 'px');
                layer.appendChild(spark);
                setTimeout(() => spark.remove(), 1400);
            }
        }

        function signPledge() {
            const input = document.getElementById('signatureInput');
            if (!input.value.trim()) {
                input.focus();
                input.placeholder = 'ì„œëª…ì„ ì ì–´ ì£¼ì„¸ìš”';
                return;
            }
            closePledge();
            launchFireworks(26);
            setTimeout(() => showCelebration(), 1400);
        }

        function goToVideo() {
            showPage('videoPage');

            const video = ensureVideoFrame();
            const tapToPlay = document.getElementById('tapToPlay');

            video.src = 'video/test.mp4';
            video.currentTime = 0;

            const tryPlay = () => {
                video.muted = true;
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        tapToPlay.classList.remove('show');
                        requestFullScreen(video);
                    }).catch(() => {
                        tapToPlay.classList.add('show');
                    });
                }
            };

            tryPlay();

            tapToPlay.onclick = () => {
                tapToPlay.classList.remove('show');
                video.muted = false;
                video.play();
                requestFullScreen(video);
            };

            video.onended = () => {
                exitFullScreen();
                showPledge();
            };

            setInterval(createMusicNote, 3000);
            setInterval(createFallingPetal, 2000);
        }

        function goToConfession() {
            showPage('confessionPage');
            setInterval(createFallingPetal, 3000);
        }

        function showCelebration() {
            showPage('celebrationPage');
            setInterval(createHeart, 300);
            setInterval(createFallingPetal, 500);
            setTimeout(() => {
                setInterval(() => {
                    createMusicNote();
                    createHeart();
                    createFallingPetal();
                }, 500);
            }, 500);
        }

        function showUnderstanding() {
            showPage('understandingPage');
            setInterval(createHeart, 2000);
            setInterval(createFallingPetal, 2500);
        }

        document.addEventListener('DOMContentLoaded', () => {
            createPetals();
            ensurePledgeModal();
            setInterval(() => {
                if (document.getElementById('introPage').classList.contains('active')) {
                    if (Math.random() > 0.6) createFallingPetal();
                    if (Math.random() > 0.8) createMusicNote();
                }
            }, 2000);
        });
    </script>
    <script type="text/plain" id="legacyScript">
        // Create animated petals
        function createPetals() {
            const petalsContainer = document.getElementById('petals');
            const petalCount = 30;
            
            for (let i = 0; i < petalCount; i++) {
                const petal = document.createElement('div');
                const isCherry = Math.random() > 0.5;
                
                petal.className = isCherry ? 'petal cherry-petal' : 'petal lily-petal';
                petal.style.left = Math.random() * 100 + '%';
                petal.style.animationDuration = (Math.random() * 5 + 6) + 's';
                petal.style.animationDelay = Math.random() * 8 + 's';
                petalsContainer.appendChild(petal);
            }
        }

        // Create individual falling petal
        function createFallingPetal() {
            const petal = document.createElement('div');
            const isCherry = Math.random() > 0.4;
            
            petal.className = isCherry ? 'petal cherry-petal' : 'petal lily-petal';
            petal.style.left = Math.random() * 100 + '%';
            petal.style.animationDuration = (Math.random() * 3 + 4) + 's';
            document.body.appendChild(petal);
            
            setTimeout(() => {
                petal.remove();
            }, 8000);
        }

        // Create floating hearts
        function createHeart() {
            const heart = document.createElement('div');
            heart.className = 'heart';
            const hearts = ['ğŸ’•', 'ğŸŒ¸', 'ğŸŒº', 'ğŸŒ·'];
            heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
            heart.style.left = Math.random() * 100 + '%';
            heart.style.animationDuration = (Math.random() * 2 + 3) + 's';
            document.body.appendChild(heart);
            
            setTimeout(() => {
                heart.remove();
            }, 5000);
        }

        // Create floating music notes
        function createMusicNote() {
            const note = document.createElement('div');
            note.className = 'music-note';
            const notes = ['â™ª', 'â™«', 'ğŸŒ¿', 'ğŸƒ'];
            note.innerHTML = notes[Math.floor(Math.random() * notes.length)];
            note.style.left = Math.random() * 100 + '%';
            note.style.top = Math.random() * 100 + '%';
            note.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(note);
            
            setTimeout(() => {
                note.remove();
            }, 4000);
        }

        // Page transitions
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            setTimeout(() => {
                document.getElementById(pageId).classList.add('active');
            }, 300);
        }

        function goToVideo() {
            showPage('videoPage');

            const video = ensureVideoFrame();
            const tapToPlay = document.getElementById('tapToPlay');

            // TODO: Update to your actual video file path
            video.src = 'video/test.mp4';
            video.currentTime = 0;

            const tryPlay = () => {
                video.muted = true;
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        tapToPlay.classList.remove('show');
                        requestFullScreen(video);
                    }).catch(() => {
                        tapToPlay.classList.add('show');
                    });
                }
            };

            tryPlay();

            tapToPlay.onclick = () => {
                tapToPlay.classList.remove('show');
                video.muted = false;
                video.play();
                requestFullScreen(video);
            };

            video.onended = () => {
                exitFullScreen();
                showPledge();
            };

            // Start background music notes and falling petals
            setInterval(createMusicNote, 3000);
            setInterval(createFallingPetal, 2000);
        }

        function goToConfession() {
            showPage('confessionPage');
            // Add gentle petal fall
            setInterval(createFallingPetal, 3000);
        }

        function showCelebration() {
            showPage('celebrationPage');
            
            // Create celebration effects
            setInterval(createHeart, 300);
            setInterval(createFallingPetal, 500);
            
            // Add special celebration music notes
            setTimeout(() => {
                setInterval(() => {
                    createMusicNote();
                    createHeart();
                    createFallingPetal();
                }, 500);
            }, 500);
        }

        function showUnderstanding() {
            showPage('understandingPage');
            
            // Gentle heart and petal animation
            setInterval(createHeart, 2000);
            setInterval(createFallingPetal, 2500);
        }

        function ensureVideoFrame() {
            const container = document.querySelector('#videoPage .video-container');
            let frame = container.querySelector('.video-frame');

            if (!frame) {
                frame = document.createElement('div');
                frame.className = 'video-frame';
                frame.innerHTML = `
                    <video id="mainVideo" class="main-video" playsinline muted></video>
                    <div class="tap-to-play" id="tapToPlay">í„°ì¹˜/í´ë¦­í•˜ì—¬ ì˜ìƒì„ ì¬ìƒí•´ ì£¼ì„¸ìš”</div>
                `;

                const placeholder = container.querySelector('.video-placeholder');
                if (placeholder) {
                    placeholder.replaceWith(frame);
                } else {
                    container.prepend(frame);
                }
            }

            return frame.querySelector('#mainVideo');
        }

        // Fullscreen helpers
        function requestFullScreen(element) {
            if (element.requestFullscreen) return element.requestFullscreen();
            if (element.webkitEnterFullscreen) return element.webkitEnterFullscreen();
            if (element.webkitRequestFullscreen) return element.webkitRequestFullscreen();
            if (element.msRequestFullscreen) return element.msRequestFullscreen();
        }

        function exitFullScreen() {
            if (document.exitFullscreen) return document.exitFullscreen();
            if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
            if (document.msExitFullscreen) return document.msExitFullscreen();
        }

        function ensurePledgeModal() {
            if (document.getElementById('pledgeModal')) return;

            const modalHtml = `
                <div class="pledge-modal" id="pledgeModal" aria-hidden="true">
                    <div class="pledge-paper">
                        <button class="pledge-close" onclick="closePledge()">Ã—</button>
                        <h2 class="pledge-title">ì„œì•½ì„œ</h2>
                        <ul class="pledge-list">
                            <li class="pledge-item">1. í˜‘ë ¥í•˜ê³  ì‹ ë¢°í•˜ë©° ì„œë¡œ ì•„ë¦„ë‹¤ìš´ ê°ì •ì„ ì§€í‚¨ë‹¤.</li>
                            <li class="pledge-item">2. ì‹œê°„ì„ ì†Œì¤‘íˆ ì‚¬ê³ , ë°”ì˜ë”ë¼ë„ ì„œë¡œì—ê²Œ ì´ì•¼ê¸°í•œë‹¤.</li>
                            <li class="pledge-item">3. ì„œë¡œì˜ ë§Œì¡±ê³¼ ë‹¤ì–‘ì„±ì„ ì¡´ì¤‘í•˜ë©°, ìƒë°˜ëœ ìƒê°ì„ ì˜¬ë ¤ë†“ëŠ”ë‹¤.</li>
                            <li class="pledge-item">4. íŒŒì´íŠ¸ë¥¼ í•  ë•Œë„ ê°ì •ì„ ë‚¨ê²¨ë‘ê³  ì‹ ë¢°ë¥¼ ê°€ì§€ë„ë¡ ë…¸ë ¥í•œë‹¤.</li>
                            <li class="pledge-item">5. ì§€ê¸ˆì˜ ì†Œì¤‘í•œ ë§ˆìŒì„ ì˜ì›í•˜ê²Œ ê°„ì§í•œë‹¤.</li>
                        </ul>
                        <div class="signature-row">
                            <canvas class="signature-canvas" id="signatureCanvas"></canvas>
                            <div class="signature-actions">
                                <button class="signature-clear" onclick="clearSignature()">ë‹¤ì‹œ ì“°ê¸°</button>
                                <button class="sign-button" onclick="signPledge()">ì„œëª…í•˜ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fireworks-layer" id="fireworksLayer"></div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Pledge modal controls
        function showPledge() {
            ensurePledgeModal();
            const modal = document.getElementById('pledgeModal');
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closePledge() {
            const modal = document.getElementById('pledgeModal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function signPledge() {
            const input = document.getElementById('signatureInput');
            if (!input.value.trim()) {
                input.focus();
                input.placeholder = 'ì„œëª…ì„ ì ì–´ ì£¼ì„¸ìš”';
                return;
            }

            closePledge();
            launchFireworks(26);

            setTimeout(() => {
                showCelebration();
            }, 1400);
        }

        function launchFireworks(count) {
            const layer = document.getElementById('fireworksLayer');
            const colors = ['#ffb3d6', '#ffcccb', '#98e4d6', '#ffd6e7', '#fce38a'];

            for (let i = 0; i < count; i++) {
                const spark = document.createElement('div');
                spark.className = 'firework';
                const angle = Math.random() * Math.PI * 2;
                const distance = 60 + Math.random() * 140;
                spark.style.left = Math.random() * 100 + '%';
                spark.style.top = Math.random() * 80 + '%';
                spark.style.background = colors[Math.floor(Math.random() * colors.length)];
                spark.style.setProperty('--dx', Math.cos(angle) * distance + 'px');
                spark.style.setProperty('--dy', Math.sin(angle) * distance + 'px');
                layer.appendChild(spark);

                setTimeout(() => {
                    spark.remove();
                }, 1400);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createPetals();
            ensurePledgeModal();
            
            // Add gentle falling petals and notes on intro
            setInterval(() => {
                if (document.getElementById('introPage').classList.contains('active')) {
                    if (Math.random() > 0.6) createFallingPetal();
                    if (Math.random() > 0.8) createMusicNote();
                }
            }, 2000);
        });

        // Add click sound effect (optional)
        function playClickSound() {
            // You can add audio here if needed
            // const audio = new Audio('click-sound.mp3');
            // audio.play();
        }

        // Add click sound to all buttons
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                playClickSound();
            }
        });
    </script>
</body>
</html>
